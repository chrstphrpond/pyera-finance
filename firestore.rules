rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to validate user data
    function isValidUser(data) {
      return data.keys().hasAll(['email']) &&
             data.email is string &&
             (data.displayName == null || data.displayName is string) &&
             (data.photoUrl == null || data.photoUrl is string) &&
             (data.currency == null || data.currency is string);
    }
    
    // Helper function to validate transaction data
    function isValidTransaction(data) {
      return data.keys().hasAll(['amount', 'type', 'date', 'categoryId']) &&
             data.amount is number && data.amount >= 0 &&
             data.type is string && (data.type == 'income' || data.type == 'expense') &&
             data.date is timestamp &&
             data.categoryId is string &&
             (data.title == null || data.title is string) &&
             (data.description == null || data.description is string);
    }
    
    // Helper function to validate category data
    function isValidCategory(data) {
      return data.keys().hasAll(['name', 'type', 'color']) &&
             data.name is string && data.name.size() > 0 &&
             data.type is string && (data.type == 'income' || data.type == 'expense') &&
             data.color is string && data.color.size() > 0 &&
             (data.icon == null || data.icon is string);
    }
    
    // Helper function to validate bucket/goal data
    function isValidBucket(data) {
      return data.keys().hasAll(['name', 'targetAmount', 'currentAmount', 'targetDate']) &&
             data.name is string && data.name.size() > 0 &&
             data.targetAmount is number && data.targetAmount >= 0 &&
             data.currentAmount is number && data.currentAmount >= 0 &&
             data.targetDate is timestamp;
    }
    
    // Helper function to validate debt data
    function isValidDebt(data) {
      return data.keys().hasAll(['name', 'amount', 'type', 'date']) &&
             data.name is string && data.name.size() > 0 &&
             data.amount is number && data.amount >= 0 &&
             data.type is string && (data.type == 'lent' || data.type == 'borrowed') &&
             data.date is timestamp &&
             (data.dueDate == null || data.dueDate is timestamp) &&
             (data.personName == null || data.personName is string);
    }

    // Users can only access their own data
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId && isValidUser(request.resource.data);
      allow update: if request.auth != null && request.auth.uid == userId && isValidUser(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == userId;
      
      // Transactions subcollection
      match /transactions/{transactionId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId && isValidTransaction(request.resource.data);
        allow update: if request.auth != null && request.auth.uid == userId && isValidTransaction(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
      
      // Categories subcollection  
      match /categories/{categoryId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId && isValidCategory(request.resource.data);
        allow update: if request.auth != null && request.auth.uid == userId && isValidCategory(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
      
      // Buckets/Goals subcollection
      match /buckets/{bucketId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId && isValidBucket(request.resource.data);
        allow update: if request.auth != null && request.auth.uid == userId && isValidBucket(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
      
      // Debts subcollection
      match /debts/{debtId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId && isValidDebt(request.resource.data);
        allow update: if request.auth != null && request.auth.uid == userId && isValidDebt(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Audit logs - read-only for users, write by Cloud Functions only
    match /audit_logs/{logId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions can write
    }
  }
}
